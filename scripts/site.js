// Generated by CoffeeScript 1.4.0
var config, find, loadJSON, posts, routing, show;

posts = [];

config = {
  max_posts: 2
};

loadJSON = function(url, callback) {
  return $.ajax({
    url: url,
    dataType: 'json',
    error: function() {
      return console.dir(arguments);
    },
    success: function(data) {
      return callback(data);
    }
  });
};

find = function(slug) {
  return _.find(posts, function(post) {
    return post.slug === slug;
  });
};

show = function(post) {
  var article, date, time;
  date = post.moment.format('MMMM d, YYYY');
  time = post.moment.format('HH:mm A ZZ');
  article = $(document.createElement('article'));
  return article.append("<header><h1>" + post.title + "</h1><h2>" + post.datetime + "</h2></header>");
};

routing = function(map) {
  var router;
  return router = new Davis(function() {
    var route, _i, _len, _ref, _results;
    this.configure(function(config) {
      config.generateRequestOnPageLoad = true;
      return config.handleRouteNotFound = true;
    });
    this.bind('routeNotFound', function(request) {
      return request.redirect('/');
    });
    _ref = map.routes;
    _results = [];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      route = _ref[_i];
      _results.push(this.get(route.pattern, map.fn[route.fn]));
    }
    return _results;
  });
};

$(function() {
  return loadJSON('posts/index.json', function(data) {
    var i, max, post, _i, _j, _len, _ref;
    posts = [];
    _ref = data.posts;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      post = _ref[_i];
      post.moment = moment(post.date, 'YYYY-MM-DDTHH:mmZZ');
      post.date = post.moment.format('d MMM YYYY');
      post.dateValue = post.moment.valueOf();
      post.data = null;
      posts.push(post);
    }
    posts.sort(function(a, b) {
      return b.dateValue - a.dateValue;
    });
    max = posts.length > config.max_posts ? config.max_posts : posts.length;
    for (i = _j = 0; 0 <= max ? _j < max : _j > max; i = 0 <= max ? ++_j : --_j) {
      $('#posts').append("<li><a href=\"" + posts[i].slug + "\">" + posts[i].title + "</a> <span class=\"date\">" + posts[i].date + "</span></li>");
    }
    return routing({
      fn: {
        latest: function(request) {
          return request.redirect("/" + posts[0].slug);
        },
        selected: function(request) {
          post = find(request.params.post);
          if (post != null) {
            return show(post);
          } else {
            return request.redirect("/latest");
          }
        }
      },
      routes: [
        {
          pattern: '/',
          fn: 'latest'
        }, {
          pattern: '/latest',
          fn: 'latest'
        }, {
          pattern: 'latest',
          fn: 'latest'
        }, {
          pattern: '/:post',
          fn: 'selected'
        }, {
          pattern: ':post',
          fn: 'selected'
        }
      ]
    });
  });
});
